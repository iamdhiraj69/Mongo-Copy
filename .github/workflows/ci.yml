name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    name: Test on Node ${{ matrix.node-version }} and ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        node-version: [20.x, 22.x]
        os: [ubuntu-latest, windows-latest, macos-latest]
        mongodb-version: [7.0]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: Start MongoDB (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          docker run -d -p 27017:27017 mongo:${{ matrix.mongodb-version }}
          sleep 5

      - name: Start MongoDB (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew tap mongodb/brew
          brew install mongodb-community@7.0
          brew services start mongodb-community@7.0
          sleep 5

      - name: Install MongoDB (Windows)
        if: matrix.os == 'windows-latest'
        run: choco install mongodb.portable -y --no-progress

      - name: Prepare MongoDB and find mongod.exe (Windows)
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: |
          New-Item -ItemType Directory -Force -Path "C:\data\db" | Out-Null
          try { RefreshEnv } catch {}
          Write-Host "Listing chocolatey lib folders for debugging..."
          Get-ChildItem -Path "C:\ProgramData\chocolatey\lib" -Force | ForEach-Object { Write-Host $_.FullName }
          $toolsPath = "C:\ProgramData\chocolatey\lib\mongodb.portable\tools"
          if (Test-Path $toolsPath) {
            Write-Host "Found expected tools path: $toolsPath"
          } else {
            Write-Host "Expected tools path not found: $toolsPath (continuing to recursive search)"
          }
          $candidates = @()
          $searchRoots = @(
            "C:\ProgramData\chocolatey\lib\mongodb.portable",
            "C:\ProgramData\chocolatey\lib",
            "C:\Program Files",
            "C:\Program Files (x86)"
          )
          foreach ($root in $searchRoots) {
            if (Test-Path $root) {
              $found = Get-ChildItem -Path $root -Recurse -Filter "mongod.exe" -ErrorAction SilentlyContinue -Force
              if ($found) { $candidates += $found }
            }
          }
          if (-not $candidates -or $candidates.Count -eq 0) {
            Write-Host "No mongod.exe found in searched locations. Full recursive search of C: (this may take a few seconds)..."
            $candidates = Get-ChildItem -Path "C:\" -Recurse -Filter "mongod.exe" -ErrorAction SilentlyContinue -Force
          }
          if (-not $candidates -or $candidates.Count -eq 0) {
            Write-Error "mongod.exe not found on runner. Chocolatey install may have failed or layout is unexpected. Here are the chocolatey lib contents for debugging:"
            Get-ChildItem -Path "C:\ProgramData\chocolatey\lib" -Force | ForEach-Object { Write-Host $_.FullName }
            exit 1
          }
          $mongod = $candidates | Where-Object { $_.FullName -match 'mongodb' } | Select-Object -First 1
          if (-not $mongod) { $mongod = $candidates | Select-Object -First 1 }
          Write-Host "Selected mongod.exe: $($mongod.FullName)"
          echo "MONGODB_PATH=$($mongod.FullName)" >> $env:GITHUB_ENV

      - name: Start MongoDB (Windows)
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: |
          Write-Host "Starting mongod from $env:MONGODB_PATH"
          $mongodProc = Start-Process -FilePath $env:MONGODB_PATH -ArgumentList "--dbpath", "C:\data\db", "--bind_ip", "127.0.0.1" -NoNewWindow -PassThru
          $retries = 60
          $success = $false
          do {
            Start-Sleep -Seconds 1
            $proc = Get-Process -Id $mongodProc.Id -ErrorAction SilentlyContinue
            if (-not $proc) {
              Write-Host "mongod process is not running anymore."
              Get-EventLog -LogName Application -Newest 50 | Select-Object -First 50 | Format-Table -AutoSize
              break
            }
            try {
              $tcp = New-Object System.Net.Sockets.TcpClient
              $iar = $tcp.BeginConnect("127.0.0.1", 27017, $null, $null)
              $wait = $iar.AsyncWaitHandle.WaitOne(500)
              if ($wait -and $tcp.Connected) {
                $tcp.EndConnect($iar)
                $tcp.Close()
                $success = $true
              } else {
                try { $tcp.Close() } catch {}
              }
            } catch {}
            if (-not $success) {
              $retries--
              Write-Host "Waiting for mongod (tcp probe)... retries left: $retries"
            }
          } while (-not $success -and $retries -gt 0)
          if (-not $success) {
            Write-Error "MongoDB failed to start within the timeout window (TCP probe). Dumping process list for debugging:"
            Get-Process | Where-Object { $_.ProcessName -like "*mongo*" } | Format-Table -AutoSize
            $possibleLogs = @("C:\data\db\mongod.log", (Join-Path -Path (Split-Path $env:MONGODB_PATH -Parent -Parent) -ChildPath "log\mongod.log"))
            foreach ($p in $possibleLogs) {
              if (Test-Path $p) {
                Write-Host "== Contents of $p =="
                Get-Content $p -Tail 200 -ErrorAction SilentlyContinue
              }
            }
            try { Get-EventLog -LogName Application -Newest 50 | Format-Table -AutoSize } catch {}
            exit 1
          }
          echo "MONGOD_PID=$($mongodProc.Id)" >> $env:GITHUB_ENV

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run tests
        run: npm test
        env:
          SOURCE_DB_URI: mongodb://localhost:27017
          TARGET_DB_URI: mongodb://localhost:27017
          DB_NAME: test_db

      - name: Stop MongoDB (macOS)
        if: matrix.os == 'macos-latest'
        run: brew services stop mongodb-community@7.0

      - name: Stop MongoDB (Windows)
        if: matrix.os == 'windows-latest'
        shell: powershell
        run: |
          if ($env:MONGOD_PID) {
            try {
              Write-Host "Stopping mongod PID $env:MONGOD_PID"
              Stop-Process -Id $env:MONGOD_PID -Force -ErrorAction SilentlyContinue
            } catch {
              Write-Host "Failed to stop process by PID; attempting to stop any mongod processes."
              Get-Process mongod -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue
            }
          } else {
            Write-Host "No MONGOD_PID set; attempting to stop any mongod processes."
            Get-Process mongod -ErrorAction SilentlyContinue | Stop-Process -Force -ErrorAction SilentlyContinue
          }
        continue-on-error: true
